<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unir Imágenes a PDF</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: grid;
            place-items: center;
            min-height: 90vh;
            background-color: #f4f4f4;
        }
        #drop-zone {
            width: 500px;
            height: 300px;
            border: 4px dashed #ccc;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.2em;
            color: #777;
            transition: all 0.3s ease;
        }
        /* Estilo cuando arrastramos algo sobre la zona */
        #drop-zone.dragover {
            border-color: #007bff;
            background-color: #f0f8ff;
            color: #007bff;
        }
        #file-list {
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div>
        <h1>Arrastra y suelta tus imágenes aquí</h1>
        <div id="drop-zone">
            Suelta las imágenes (JPG, PNG) aquí
        </div>
        <p id="file-list">Archivos subidos: 0</p>
        <button id="submit-button" style="display:none;" disabled>Generando PDF...</button>
    </div>

    <script>
        // Obtenemos los elementos del HTML
        const dropZone = document.getElementById('drop-zone');
        const fileListDisplay = document.getElementById('file-list');
        const submitButton = document.getElementById('submit-button');

        // Esta lista guardará los archivos que el usuario suelte
        let droppedFiles = [];

        // --- Eventos de "Arrastrar y Soltar" ---

        // Prevenimos el comportamiento por defecto del navegador (que es abrir la imagen)
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Añadimos la clase 'dragover' para el efecto visual
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });

        // Quitamos la clase 'dragover'
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        // --- El evento principal: "Drop" (Soltar) ---

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            // Obtenemos la lista de archivos que el usuario soltó
            let dt = e.dataTransfer;
            let files = dt.files;

            // Guardamos los archivos y actualizamos el contador
            droppedFiles = Array.from(files); // Convertimos la lista de archivos a un Array
            fileListDisplay.textContent = `Archivos subidos: ${droppedFiles.length}`;

            // Si hay archivos, llamamos a la función para subirlos
            if (droppedFiles.length > 0) {
                uploadFiles(droppedFiles);
            }
        }

        // --- Función para enviar los archivos al Backend (Python) ---

        async function uploadFiles(files) {
            // Mostramos un mensaje de "Generando..."
            submitButton.style.display = 'block';
            dropZone.textContent = 'Procesando...';

            // 1. Creamos un objeto FormData (es como un formulario HTML virtual)
            const formData = new FormData();
            
            // 2. Añadimos todos los archivos al FormData
            // La clave 'images' debe ser la misma que usamos en Flask (request.files.getlist('images'))
            files.forEach(file => {
                formData.append('images', file);
            });

            try {
                // 3. Enviamos los archivos al backend usando 'fetch'
                const response = await fetch('/generar-pdf', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.statusText}`);
                }

                // 4. Recibimos la respuesta (el PDF)
                const pdfBlob = await response.blob();

                // 5. Creamos un enlace temporal para descargar el archivo
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mi_pdf_unido.pdf'; // Nombre del archivo
                document.body.appendChild(a);
                a.click(); // Simulamos un clic para que inicie la descarga
                
                // Limpiamos todo
                a.remove();
                URL.revokeObjectURL(url);
                resetUI();

            } catch (error) {
                console.error('Error al subir archivos:', error);
                dropZone.textContent = 'Error. Intenta de nuevo.';
                submitButton.style.display = 'none';
            }
        }

        function resetUI() {
            droppedFiles = [];
            fileListDisplay.textContent = 'Archivos subidos: 0';
            submitButton.style.display = 'none';
            dropZone.textContent = 'Suelta las imágenes (JPG, PNG) aquí';
        }

    </script>
</body>
</html>